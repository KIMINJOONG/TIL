# PHP 컨테이너 추가

- php 컨테이너에서는 커스텀 Dockerfile을 사용하고자한다.
- 도커허브에서 php 이미지를 기반으로 커스텀 이미지 만들예정 Laravel이 필요로하는 몇몇 확장 프로그램 설치

1. dockerfiles라는 폴더 생성
2. php.dockerfile 파일 생성 (이름은 상관없으나 명명패턴으로 이 이름 사용)
   - php.dockerfile
   1. php:7.4-fpm-alpine을 가져온다.
   2. 필요한 부가 종속성 설치 명령어 추가(RUN docker-php-ext-install pdo pdo_mysql)
   3. 작업 디렉토리는 /var/www/html로 설정
   4. CMD나 ENTRYPOINT는 존재x
      - 여기서는 사용안함. CMD 또는 ENTRYPOINT가 없으면 베이스 이미지의 CMD 또는 ENTRYPOINT를 사용(거기에 있다면) php베이스 이미지에는 실행되는 디폴트 명령이 존재. php인터프리터를 호출하는 명령. 즉, 여기에서 우리가 만드닌 이 이미지는 해석되어야하는 PHP파일이 들어오면 이들이 처리됨
3. 아래 도커 컴포즈 코드 참고

```
php:
    build:
      context: ./dockerfiles
      dockerfile: php.dockerfile
```

4. 이제 해야할 두가지 작업이 존재

   - 첫번째는 PHP인터프리터가 소스코드에 접근 할 수 있도록하는것. 결국 소스코드는 컨테이너의 내부폴더에서 사용가능해야한다. 즉, 바인드마운트가 필요.(/var/www/html에 마운트)

   1. src라는 폴더 생성
   2. docker-compose파일에 volumes추가로 바인드마운트

   ```
   volumes:
      - ./src:/var/www/html:delegated
   ```

   - 끝에 콜론을 넣고 그뒤에 delegated를 추가하면 성능을 약간 향상시킬수있다. 이것은 결국 컨테이너가 일부 데이터를 기록해야 하는 경우에 그에 대한 결과를 로컬에 즉시 반영하지않고 배치로 기본처리함으로써 성능이 약간 나아짐

   - 두번째는 이 PHP인터프리터가 작업용으로 수신하는 포트에 대한것.
   - 이 포트는 nginx.conf에 정의되어있는데, php:3000; 이라고 있다. 보통은 127.0. 이런식의 IP이지만 하나의 docker-compose파일에서 생성된 모든 컨테이너는 동일한 네트워크의 일부이며 서로를 이름으로 찾을수있다.
   - 실제 공식 php이미지의 PHP의 포트는 9000을 노출하고있다.
   - 따라서 컨테이너는 9000이기때문에 3000을 9000으로 매핑해줘야한다.

   ```
   ports:
      - "3000:9000"
   ```

   - 정말 이게 우리에게 필요한걸까? 결국 이 php컨테이너와 통신하려는것은 nginx 서버이다. 이 경우 포트는 컨테이너에 바로 연결된다. 로컬 호스트 머신에서 전송하는 경우가 아님
   - 따라서 이 매핑은 아무런 작업도 수행하지 않음
   - 호스트 머신에서 php 컨테이너와 상호작용하려는 경우네는 매핑가능
   - 그러나 server 컨테이너에서 요청을 전송하기 위해 할 필욘 없다. 대신 nginx.conf 파일의 포트를 9000으로 변경
   - 이유는 컨테이너간 직접 통신을 하고있기 때문.
