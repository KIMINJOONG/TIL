# 다른 볼륨 결합 & 병합하기

## 새로 추가한 바운드 마운트의 정확한 문제는 무엇일까?

- 우리는 이 폴더, 그 폴더에 있는 모든것을 app 폴더에 바인딩하는것을 명심하자. 컨테이너 내부의 'app' 폴더를 로컬 폴더로 덮었쓰는것이 끝이 아니다. 처음에 이미지가 생설될때 모든것을 app 폴더에 복사한다. 모든 종속성을 설치하지만, 결국 이미지 생성을 위해 수행한 모든 단계가 무의미하게 되는데, 이 마운트를 컨테이너에 바인딩하면 어쨌든 'app'폴더의 모든것을 로컬 폴더로 덮어쓰기 때문이다. 그리고 이 로컬 폴더에는 앱에 필요한 모든 종속성이 있는 node_modules가 없다. 이것이 오류가 발생한 이유다. 즉 로컬폴더를 'app'폴더에 마운트하기때문에 이미지와 컨테이너를 설정할때 수행한 모든 작업을 덮어쓴다.

## 먼저 컨테이너가 볼륨 및 바인드 마운트와 상호작용하는 방식을 이해해보자.

- 컨테이너와 볼륨 및 바인드 마운트를 가지고있다면 -v 플래그를 사용하여 컨테이너에 둘 다 마운트 가능. 즉, 컨테이너 내부의 어떤 폴더가 호스트 머신의 폴더에 마운트되거나 연결된다. 컨테이너 내부에 이미 파일이 있다고 가정, 이경우에도 외부 볼륨에 파일이 존재하는데 새 파일을 작성하면 호스트 머신의 폴더에도 추가된다. 컨테이너를 시작하면 볼륨에서 파일을 찾는다. 아직 내부에 파일이 없어, 볼륨에서 파일을 로드한다. 그래서 바인드 마운트를 활용. 컨테이너 내부에 파일이 없다고 가정. 로컬 호스트 시스템에는 파일이 존재. 이 경우, 파일을 기본적으로 컨테이너 내부에서도 사용할수있지만, 두가지 일이 발생. 컨테이너 내부의 'app'폴더에 파일을 가지고 있다. 그리고 컨테이너 외부에 있는 로컬 호스트 머신의 폴더에 파일과 폴더가 있다. 좋은 점은 도커가 호스트 머신의 로컬 파일을 덮어쓰지않는다는것이다. 만약 그렇게 한다면 실수로 컴퓨터에서 많은 중요한것들을 삭제할수있다. 그래서 그런일이 발생하지않도록 도커는 로컬 호스트 폴더를 덮어쓰지않는다. 대신 로컬 호스트 폴더와 그 안에 있는 콘텐츠가 도커 컨테이너에 있는 내용을 덮어쓴다. 그때문에 node_modules등이 제거가 된것이다.

## 해결방법

- 도커에게 내부 파일 시스템에 특정 부분이 있다는것을, 외부에서 덮어쓰지 않아야하는 부분이 있다는걸 알려줘야한다. 이것은 또다른 볼륨으로 해결할수있다. 도커 컨테이너에 익명 볼륨을 추가한다. 이것은 익명의 볼륨이 도움이 될 수 있는 사용사례이기도하다.

```
docker run -d --rm -p 3000:80 --name feedback-app -v feedback:/app/feedback -v "/Users/admin/TIL/Docker&Kubernetes/data-volumes-01-starting-setup:/app" -v /app/node_modules feedback-node:volumes
```

이것이 도움이되는 이유?
도커는 항상 컨테이너에 설정하는 모든 볼륨을 평가하며, 충돌이 있는 경우에는 더 긴 '내부'경로를 우선한다. 예를들어, 무언가에 바인딩된 app볼륨이 있고, 무언가에 바인딩된 app/node_modules 볼륨이 있다.
이름을 지정하진 않았지만, 익명 볼륨의 경우에도 도커가 관리하고 로컬 시스템 어딘가에 매핑된 폴더가 있다는점을 기억하자. 도커는 어떤 볼륨이 'app'폴더에 매핑되고, 어떤 볼륨이 'app/node_modules' 폴더에 매핑되는지 확인한다. 이런 경우, 도커가 가진 간단한 규칙은 더길고 더 구체적인 경로를 채택한다. 즉 여전히 'app' 폴더에 바인딩할수있지만, 'app'폴더 내부의 'node_modules' 폴더에 바인딩한다. 참고로 'node_modules'폴더는 npm install 명령어로 생성된 디폴트폴더이다.
그러면 'node_modules'폴더가 살아남아 이 폴더가 외부에서 들어오는 유입, 즉, 이 볼륨때문에 발생한 이러한것을 덮어쓰게 된다. 그리고 바운드 마운트는 실제로 'node_modules'폴더를 전달하지 않는다. 그래서 'node_modules'폴더는 존재하지않는 'node_modules'폴더를 덮어쓴다. 간단히 말하면, npm install을 사용하여 이미지 생성중에 생성된 'node_modules'폴더는 살아남아 여전히 작동하는 바인드 마운트와 함께 공존한다. 일종의 예외라고 할 수 있다.

# 결과

- 이전의 파일도 여전히 존재하는걸 확인할수있고, 추가적인 이점은 HTML파일에서 무언가를 변경한후 새로고침하면 이미지 리빌드 없이 변경사항을 즉시 볼수있다. 그 이유는 바인드 마운트를 추가했기때문이다. 익명볼륨을 추가하는경우에만 작동하는데 이유는 'node_modules'폴더가 바인드 마운트 폴더의 내용물로 덮어쓰여지지않기때문이다.
