# 멀티 스테이지 빌드 소개

- 멀티스테이지 빌드를 사용하면 파일 내부에 스테이지라고하는 여러 빌드 단계 또는 설정단계를 정의하는 하나의 Dockerfile을 가질 수 있다.

- 스테이지는 서로의 결과를 복사할수있으므로 최적화된 파일을 생성한느 스테이지와 그 파일을 제공하는 다른 스테이지를 가짐

- 위에서 아래로 단계별로 모든 스테이지를 거쳐 전체 Dockerfile을 빌드
- 또는 멀티 스테이지 빌드와 멀티 스테이지로 부터의 모든 단계를 건너뛰어 빌드하기 위해 개별 스테이지를 선택

- 멀티스테이지 빌드에서는 'CMD'대신 RUN을 사용

```
CMD ["npm", "run", "build]

RUN npm run build
```

- 그리고 이 명령후에 다른 베이스 이미지로 전환하고자 한다.(빌드된 최적화된 파일만 필요함)

- 최적화파일을 얻으면 더 이상 node가 필요없음. nginx사용가능
- RUN 명령후 다른 베이스 이미지로 전환하기위해 두번째 FROM을 넣어줌
- 실제로는 하나만 있어야하지만 전환 가능하다. FROM이 들어가면 새 베이스 이미지로 전환됨

- RUN 이후

```
FROM nginx:stable-alpine


```

- 첫번째 스테이지기존 FROM 뒤에 as를 사용하여 이름을 정해줄수있음
- 두번째 스테이지에서 COPY명령에 --from 옵션을 사용하면 첫번째 단계에서 복사할수있다.

```
FROM node:14-alpine as build


2 스테이지

COPY --from=build
```

- 이 의미는 build스테이지에서 최종 콘텐츠를 복사한다는 뜻
- 처음부터 두번째 FROM명령까지의 모든명령이 이 새로운 스테이지로 들어감
- 이전에 복사할때와 마찬가지로 소스 경로 지정

```
COPY --from=build /app/build /usr/share/nginx/html
```

- /usr/share/nginx/html: 간단하게 정적파일을 배포하기위한 경로.(도커허브 공식이미지 리포지터리에 가면 볼수있다.)

- 최종컨테이너에는 두번째 스테이지만 포함되지만 우선적으로 최종 스테이지를 파생시키기위해 첫번째 스테이지를 빌드. 그리고 동일한 Dockerfile에서
  둘 이상의 스테이지를 가질수있고, 필요한 경우 여러개도 가능하다.

```
EXPOSE 80

CMD ["nginx", "-g", "damon off;"]
```

- 이것은 강력한 기능이다! 꼭 까먹지 말고 기억해두자.
