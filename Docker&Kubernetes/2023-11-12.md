# ECS로 EFS 볼륨 사용하기

- 하나의 목표를 저장한다음 발생할수있는 첫번째 문제

  1. 코드에서 무언가를 변경한다(로그 메세지에 '!' 추가)
  2. docker build 명령을 사용하여 리빌드
  3. tag명령을 사용하여 최신 변경사항을 저장소 이미지에도 적용
  4. 도커허브로 푸시
  5. aws ecs서비스로 이동 새 배포 강제 실행
  6. 서비스 태스크 재시작
  7. 동일한 GET요청을 동일한 도메인, 동일한 URL로 전송

- 이전 데이터베이스에 저장된 목표는 손실됨
- 데이터베이스가 컨테이너에서 실행되고있으니까 당연한것
- 태스크가 실행되고 있는한 데이터는 영구적 그러나 예를 들어, 새 컨테이너 이미지를 사용하려고 하면 서비스를 업데이트할때 태스크가 종료되고 재시작되면 모든 데이터가 손실 됨

- ECS에서도 볼륨을 해주자
  1. 최신 태스크 정의
  2. 이전 정의를 기반으로 새로 생성
  3. Volumes에서 볼륨을 추가
  4. data 볼륨 유형은 EFS
     - EFS는 Elastic File System 탄력적 파일시스템
     - 서버에서 덜 실행되는 컨테이너에 파일 시스템을 연결하는걸 가능케함.
     - FARGET을 사용하고있기때문에 우리가 관리하는 서버 없이 실행중 그래서 EFS를 사용하면 하드 드라이브 연결가능. 컨테이너가 재배포 되더라도 살아남는다.
     - 따라서 EFS콘솔로 이동하여 새 파일 시스템을 생성해야함.
     - 이름은 db-storage
     - VPC추가 이전에 ECS에 사용한것과 동일한 VPC 사용
     - 하나의 설정 커스터마이징 필요. Network access에서 타깃을 마운트 해야함.
     - 타깃을 추가하지 않고, 우리가 선택한 VPC에 있는 서브넷을 추가한다면, 보안그룹에서 새 보안그룹을 만들고, 이름은 efs-sc로 지정 VPC에 파일 시스템 및 ECS에도 사용하는 VPC를 추가하고, 인바운드 규칙 추가
     - 드롭다운에서 NFS선택
     - 목표 보안 그룹을 선택
     - 이것이 탄력적 파일 시스템 서비스와 거기에서 생성하는 파일 시스템을 위해 새로운 보안그룹을 만드는 이유(보안 그룹과 인바운드 규칙없이, ECS의 컨테이너와 태스크는 EFS와 통신 불가능)
     - EFS로 돌아가서 위의 새로 만든 보안그룹 선택
     - create로 생성
  5. ECS 콘솔로 돌아감 새로 생성된 파일 시스템 선택
  6. 액세스 포인트는 파일시스템 내부의 중첩 경로를 대상으로 하는것을 허용.
     - 다중 볼륨을 가지고 있고, 다중 파일 시스템을 생성하고 싶지 않다면 액세스 포인트로 작업하여 다른 볼륨에 대한 단일 파일 시스템 상에서 다른 중첩 폴더를 가질수있다.
  7. 컨테이너에 볼륨 연결
     - mongodb 컨테이너에 config를 눌러서 스토리지와 로깅으로 이동.
     - 마운트 포인트에서 방금 추가한 data 볼륨 추가. 컨테이너 내부인 '/data/db' 경로에 바인딩
  8. Actions, Update Service로 이동하여 새 개정판으로 서비스를 강제 재배포.
  9. 강의 촬영시점에서는 플랫폼 버전에서 1.4.0을 선택해야함(왜 1.4.0? 이게 EFS볼륨을 지원하는 버전)
  10. 목표를 저장한후, 서비스를 재시작하면 태스크가 중지됐다.
      - why? 이전 태스크가 계속 실행되는 동안 새 테스크가 시작되기때문이다. 새 테스크가 성공적으로 시작되어 정상 모드에서 실행중인 경우에만 이전 태스크가 중지된다.
      - 이것은 좋은 전략이지만 두개의 mongodb 컨테이너를 지닌 두개의 태스크가 있으며, 각 태스크는 하나의 컨테이너를 가진다는 의미, 그리고 동시에 하나의 동일한 파일 시스템과 상호작용하려고함 그렇기때문에 에러가 발생.
      - 새 태스크를 배포하려고 할때, 동시에 실행중인 태스크가 두개.
      - 일단 배포 되면 하나의 태스트만 있으면 문제 발생 x
      - 그러므로 현재 실행중 태스크, 배포하려는 태스크 둘다 동시에 EFS의 동일한 폴더에 있는 동일 파일에 쓰려고 한다는 의미이기도 하다. 그리고 그건 사용자가 요청을 전송할때, 디스크에 파일을 쓰려고 한다면 이는 현재 배포중인 태스크가 아닌 실행중인 태스크에 대해서만 발생한다.
      - 그 외에도 들어오는 모든요청에 다른 파일을 쓸수있고, 즉 동일한 파일에 두번 쓰지 않는다.
      - 현재 실행중인 태스크를 수동으로 중지하여 제거(배포된 태스크가 활성화 되도록)
