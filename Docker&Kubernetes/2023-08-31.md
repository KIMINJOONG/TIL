# 문제이해하기

- 우리가 띄운 feedback-app은 뭔가 문제가 하나 있다. 우선 컨테이너를 중지해보자.
  그리고 --rm을 제거후 다시 실행하면 작동한다. 그러나 /feedback/awesom.txt를 보려고 하면 해당 파일이 존재하지않는다는것을 볼수있다. 좀 전엔 작동했는데 말이다. 이유는 컨테이너를 삭제했기때문이다. 예를들어 다시 save를 하면 접속이 가능한걸 볼 수 있다. 그리고 중지 후 다시 실행해보자 이번엔 실행될것이다. 왜냐하면 --rm을 빼두었기때문이다. 컨테이너를 중지는했지만 제거되지않았기때문에 파일 손실이 일어나지않았다. 이것엔 많은 의미가 있다. 이미지에는 호스팅 시스템 파일 시스템에서 분리된 자체 내부 파일 시스템이 있다. 그 다음 그 이미지를 기반으로 도커 컨테이너를 시작하면 그 이미지위에 얇은 read-write레이어로 컨테이너가 추가 된다. 따라서 기본적으로 이 이미지 파일 시스템에 액세스 할 수 있으며, 이미지를 조작하지 않고도 읽고 쓸 수 있다. 하지만 그곳에서만 읽고 쓸수있다. 매우 효율적인 방식으로 관리되는 자체 복사본을 가지는데 우리에겐 거기에서 읽고 쓸수있다는게 중요하다. 하지만 문제는 파일 시스템이 컨테이너 내부에 있다는것이다. 따라서 컨테이너를 중지하고 다시 시작해도 모든것은 정상. 컨테이너는 변경되지않았기때문에, 중지 되었다고해서 파일 시스템이 클리어 되거나, 삭제되는건 아님. 하지만 컨테이너를 제거한다면 모든 데이터가 지워짐. 새 컨테이너를 실행해도 동일한 이미지 상의 공간에 있다해도 이전 컨테이너에서 생성되어 저장된 모든 데이터는 손실된다. 왜냐하면 이미지는 읽기 전용이기 때문이다. 따라서 컨테이너느 파일을 생성할때 이미지에 쓰는게 아닌 상단에 추가되는 자체 read-write 레이어에 저장한다. 그래서 컨테이너가 제거되면 변경되지 않는 이미지만 남게되는것! 즉, 새 컨테이너를 시작하면 동일한 이미지 상에서 실행되어진 이전 컨테이너에 의해 변경된 것이 없는 동일한 기본 파일 시스템으로 시작. 이것이 도커의 핵심 아이디어. 동일한 이미지에 기반한 다수의 컨테이너가 서로에게 완전히 격리된다는것이다. 하지만 여기에는 문제가 있다. 컨테이너를 중지하고, 그 후에 제거하면 파일이 손실된다는걸 의미하니까 많은 애플리케이션에서 이런 동작이 문제가 된다. 예를 들어 컨테이너가 삭제되더라도 파일을 계속 유지하길 원하는 경우 사용자 계정이나 사용자가 제출한 제품 데이터, 갑자기 사라져선 안되고 컨테이너가 삭제되어도 생존해야만 하는 그런류의 데이터를 처리하는것. 왜냐면 실제로 컨테이너는 자주 제거될것이다. 코드에서 무언가를 변경하고 새 이미지를 빌드하고 새 컨테이너를 실행하면 이전 컨테이너는 다시 시작되지 않는다. 최신 코드 스냅샷을 사용하는 새컨테이너를 사용하고자 하므로 이 경우 모든 데이터가 손실된다.
