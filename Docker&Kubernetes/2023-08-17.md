# 이미지 레이어의 이해

- 이지를 빌드하면 명령이 실행되고 이미지가 닫힌다. 그렇기때문에 코드가 변경되어 새 코드를 새 이미지에 복사하려는 경우와 같이 무언가를 업데이트해야하는 경우 이를 다시 빌드해야한다고 배웠다.
  이를 바탕으로 이미지와 관련된 또 다른 중요한 개념이 있는데, 바로 레이어 기반이라는 것이다. 즉, 이미지를 빌드하거나 이미지를 다시 빌드할때 변경된 부분의 명령과 그 이후의 모든 명령이 재평가 된다는 의미
  도커는 기본적으로 모든 명령어에 대해 명령 결과를 캐시하고 명령어를 다시 실행했을때의 결과가 이전과 동일하다는것을 인식한다면 그 명령을 다시 거칠 필요가 없다고 추론한다면 캐시된 결과를 사용한다. 이것을 레이어기반 아키텍처라고 한다. 모든 명령은 Dockerfile의 레이러를 나타낸다.
  즉, 일단 명령이 실행되고 이미지가 빌드되면 이미지가 잠기고, 이미지를 다시 빌드하지않는한 그 코드는 변경불가하다. 이는 기술적으로 새 이미지를 생성한다는 의미이다. 다시 레이어로 돌아가보면, 모든 명령어를 기반으로 하는 이미지 레이어는 레이어를 생성하고, 이러한 레이어는 캐시된다. 그런 다음 이미지를 기반으로 컨테이너를 실행하면 그 컨테이너는 기본적으로 Dockerfile에 지정한 명령을 실행한 결과로 코드를 실행중인 애플리케이션인 이미지 위에새로운 추가 레이어를 추가한다. 이렇게하면 이미지를 레이어로 실행할때만 활성화되는 최종 레이어가 추가된다. 최종 명령 이전의 모든 명령은 이미 이미지의 일부이지만 별도의 레이어 이다. 그리고 아무것도 변경되지 않으면 이러한 모든 레이어를 캐시에서 사용할수있다. 이제 코드에서 무엇을 변경하든 상관없이 무언가를 변경하면 docker build . 시 시간이 더 오래걸린다는것을 알수있다. 캐시의 일부 결과만을 사용하기때문에 캐시의 작업 디렉토리 명령 결과를 사용했지만 복사 명령의 경우 다시 실행해야함을 알아챘기때문이다. 이는 도커가 복사해야할 파일을 스캔하고 하나의 파일이 변경된것을 감지해서 모든 파일을 다시 복사하기때문이다. 하나의 레이어가 변경될때마다 다른 모든 레이어가 다시 빌드된다고 앞서 말했다. 도커는 npm install이 이제 이전과 동일한 결과를 산출할지 그 여부를 알 수 없다. 결국 우리는 파일을 다시 복사하고 도커는 npm install에 영향을 줄 수 있는 위치와 변경할 파일에 대한 심층 분석은 수행하지 않는다. 즉, 한 레이어가 변경될때마다 모든 후속 레이어도 다시 실행되므로 npm install이 다시 실행된다. 이것이 레이어 기반 아키텍처이다. 도커는 다시 실행해야 하는 항목만 다시 빌드하여 다시 실행하여, 이미지 생성 속도를 높이기 위해 존재한다. 그러나 여기서 문제는 우리가 코드에서 무엇인가를 변경할때마다 npm install이 실행된다는것을 알 수 있다 프로젝트의 종속성을 관리하는 package.json에서 무언가를 변경하지 않는한 npm install은 사실 다시 실행될 필요없다. 왜냐하면 코드 레벨에서 수정은 프로젝트에 필요한 종속성에 영향을 미치지않기때문에 Node세계에서 npm install을 실행할 필욘없다. 여기서 최적화를 할 수가 있다.

```
FROM node

WORKDIR /app

COPY . /app

RUN npm install

EXPOSE 80

CMD ["node", "server.js"]

```

이렇게 모든 파일을 app폴더에 복사한 다음 npm install을 실행하는 대신
npm install을 먼저 실행한 후에 복사하고, npm install을 실행하기전에 package.json을 먼저 /app 폴더에 복사하는것이다.

```
FROM node

WORKDIR /app

COPY package.json /app

RUN npm install

COPY . /app

EXPOSE 80

CMD ["node", "server.js"]

```

이렇게한다면 소스 코드를 복사하기전에 npm install 레이어가 오기때문에 소스코드가 변경되어도 소스코드 복사 명령 앞의 레이어가 무효화되지 않기때문에 npm install은 다시 실행되지 않는다. 완료하는데 어느정도 시간이 걸리는 npm install이 실행되지 않기때문에 다시 빌드시 캐시된것을 사용하여 속도가 빨라지는것을 알 수 있다. 이는 도커가 package.json이 변경되지 않았음을 감지했기때문이다. 이것은 첫번째 작은 최적화이지만 최적화보다 중요한것은 우리가 왜 이것을 하는지 이것을 이해하고 이 레이어 기반 접근 방식 레이어 기반 아키텍처를 이해하는것이다. 이는 도커와 도커 이미지의 핵심개념이다.
